name: Generate iOS Project Files

on:
  workflow_dispatch:

jobs:
  generate-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Backup existing iOS files
        run: |
          mkdir -p /tmp/backup
          cp -r ios/Runner /tmp/backup/ || true
          cp -r ios/PacketTunnel /tmp/backup/ || true

      - name: Generate iOS project
        run: |
          # Remove xcodeproj to force regeneration
          rm -rf ios/Runner.xcodeproj
          # Generate project files
          flutter create --platforms=ios .

      - name: Restore custom files
        run: |
          # Restore our custom AppDelegate and PacketTunnel
          cp -r /tmp/backup/Runner/* ios/Runner/ || true
          cp -r /tmp/backup/PacketTunnel ios/ || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Generate iOS Xcode project files"
          branch: generate-ios-project
          title: "Add generated iOS Xcode project files"
          body: |
            This PR adds the generated `project.pbxproj` and other Xcode files.

            Generated by GitHub Actions on macOS runner.
